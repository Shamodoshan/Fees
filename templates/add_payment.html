{% extends 'base.html' %}

{% block content %}
<div class="glass-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>Add Payment</h1>
        <a href="/" style="color: var(--primary); text-decoration: none;">&larr; Back to Home</a>
    </div>

    {% if error_message %}
    <div class="alert alert-error"
        style="margin-bottom: 1.5rem; padding: 1rem; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33;">
        {{ error_message }}
    </div>
    {% endif %}

    <form hx-post="{% url 'add_payment' %}" hx-target="#main-content">
        <div class="form-group" style="position: relative;">
            <label for="student_name">Student Name</label>
            <input type="text" id="student_name" name="student_name" required placeholder="John Doe" autocomplete="off"
                hx-get="{% url 'get_student_details' %}" hx-trigger="keyup changed delay:500ms"
                hx-target="#student-data-bridge">
            <!-- Dropdown for autocomplete suggestions -->
            <div id="autocomplete-dropdown" class="autocomplete-dropdown" style="display: none;"></div>
        </div>

        <input type="hidden" id="student_id" name="student_id">

        <div id="student-data-bridge"></div>

        <div class="form-group">
            <label for="monthly_fee">Monthly Fee</label>
            <input type="number" step="0.01" id="monthly_fee" name="monthly_fee" placeholder="0.00" readonly>
        </div>

        <div class="form-group">
            <label for="amount">Amount</label>
            <input type="number" step="0.01" id="amount" name="amount" required placeholder="0.00">
            <div id="fee-message"></div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label for="month">Month</label>
                <input type="text" id="month_display" name="month_display" readonly placeholder="Auto-filled"
                    style="background: var(--card-bg); color: var(--text-dim); cursor: not-allowed;">
                <input type="hidden" id="month" name="month">
            </div>
            <div class="form-group">
                <label for="year">Year</label>
                <input type="text" id="year_display" name="year_display" readonly placeholder="Auto-filled"
                    style="background: var(--card-bg); color: var(--text-dim); cursor: not-allowed;">
                <input type="hidden" id="year" name="year">
            </div>
        </div>

        <div class="form-group">
            <label for="description">Description (Optional)</label>
            <textarea id="description" name="description" rows="3"></textarea>
        </div>

        <button type="submit" class="btn-submit">Save Payment</button>
    </form>
</div>

<style>
    /* Autocomplete dropdown styles */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--card-bg);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 4px;
    }

    .autocomplete-suggestion {
        padding: 0.6rem 0.8rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        color: var(--text);
    }

    .autocomplete-suggestion:last-child {
        border-bottom: none;
    }

    .autocomplete-suggestion:hover,
    .autocomplete-suggestion.selected {
        background: rgba(129, 140, 248, 0.2);
        color: var(--primary);
    }

    .autocomplete-suggestion .highlight {
        color: var(--primary);
        font-weight: 600;
    }
</style>

<script>
    // Listen for the resetPaymentForm event from HTMX
    document.body.addEventListener('resetPaymentForm', function () {
        // Clear all form fields
        document.getElementById('student_name').value = '';
        document.getElementById('student_id').value = '';
        document.getElementById('monthly_fee').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('month_display').value = '';
        document.getElementById('month').value = '';
        document.getElementById('year_display').value = '';
        document.getElementById('year').value = '';
        document.getElementById('description').value = '';

        // Clear the student data bridge and fee message
        document.getElementById('student-data-bridge').innerHTML = '';
        document.getElementById('fee-message').innerHTML = '';

        // Clear the autocomplete dropdown
        hideDropdown();

        // Focus back on the student name field for quick consecutive entry
        document.getElementById('student_name').focus();
    });

    // Autocomplete functionality
    const studentNameInput = document.getElementById('student_name');
    const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
    let selectedSuggestionIndex = -1;
    let suggestions = [];

    // Function to fetch autocomplete suggestions
    async function fetchSuggestions(query) {
        if (query.length < 1) {
            hideDropdown();
            return;
        }

        try {
            const response = await fetch(`{% url 'student_autocomplete' %}?q=${encodeURIComponent(query)}`);
            const data = await response.json();
            suggestions = data.suggestions || [];
            showSuggestions();
        } catch (error) {
            console.error('Error fetching suggestions:', error);
            hideDropdown();
        }
    }

    // Function to display suggestions
    function showSuggestions() {
        if (suggestions.length === 0) {
            hideDropdown();
            return;
        }

        const html = suggestions.map((suggestion, index) => {
            const name = suggestion.name;
            const query = studentNameInput.value;
            const highlightedName = name.replace(
                new RegExp(`(${query})`, 'gi'),
                '<span class="highlight">$1</span>'
            );
            
            return `<div class="autocomplete-suggestion" data-index="${index}" data-name="${name}">
                ${highlightedName}
            </div>`;
        }).join('');

        autocompleteDropdown.innerHTML = html;
        autocompleteDropdown.style.display = 'block';
        selectedSuggestionIndex = -1;

        // Add click handlers to suggestions
        autocompleteDropdown.querySelectorAll('.autocomplete-suggestion').forEach(item => {
            item.addEventListener('click', function() {
                studentNameInput.value = this.dataset.name;
                hideDropdown();
                studentNameInput.focus();
                // Trigger the existing HTMX search for student details
                htmx.trigger(studentNameInput, 'keyup');
            });
        });
    }

    // Function to hide dropdown
    function hideDropdown() {
        autocompleteDropdown.style.display = 'none';
        selectedSuggestionIndex = -1;
        suggestions = [];
    }

    // Function to select suggestion with keyboard
    function selectSuggestion(index) {
        const suggestionItems = autocompleteDropdown.querySelectorAll('.autocomplete-suggestion');
        
        // Remove previous selection
        if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < suggestionItems.length) {
            suggestionItems[selectedSuggestionIndex].classList.remove('selected');
        }

        // Set new selection
        selectedSuggestionIndex = index;
        if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < suggestionItems.length) {
            suggestionItems[selectedSuggestionIndex].classList.add('selected');
            studentNameInput.value = suggestions[selectedSuggestionIndex].name;
        }
    }

    // Event listeners for autocomplete
    studentNameInput.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length > 0) {
            fetchSuggestions(query);
        } else {
            hideDropdown();
        }
    });

    studentNameInput.addEventListener('keydown', function(e) {
        const suggestionItems = autocompleteDropdown.querySelectorAll('.autocomplete-suggestion');
        
        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                if (suggestions.length > 0) {
                    const newIndex = selectedSuggestionIndex < suggestions.length - 1 
                        ? selectedSuggestionIndex + 1 
                        : 0;
                    selectSuggestion(newIndex);
                }
                break;
                
            case 'ArrowUp':
                e.preventDefault();
                if (suggestions.length > 0) {
                    const newIndex = selectedSuggestionIndex > 0 
                        ? selectedSuggestionIndex - 1 
                        : suggestions.length - 1;
                    selectSuggestion(newIndex);
                }
                break;
                
            case 'Enter':
                if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < suggestions.length) {
                    e.preventDefault();
                    studentNameInput.value = suggestions[selectedSuggestionIndex].name;
                    hideDropdown();
                    // Trigger the existing HTMX search for student details
                    htmx.trigger(studentNameInput, 'keyup');
                }
                break;
                
            case 'Escape':
                hideDropdown();
                break;
        }
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!studentNameInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
            hideDropdown();
        }
    });
</script>
{% endblock %}