{% if student %}
<script>
    console.log("Student details script running for: {{ student.name }}");

    const studentNameInput = document.getElementById('student_name');
    if (studentNameInput && studentNameInput.value !== "{{ student.name }}") {
        studentNameInput.value = "{{ student.name }}";
    }

    const fee = parseFloat("{{ student.monthly_fee }}");
    const monthlyFeeInput = document.getElementById('monthly_fee');
    if (monthlyFeeInput) monthlyFeeInput.value = "{{ student.monthly_fee }}";

    const amountEl = document.getElementById('amount');
    if (amountEl) {
        const currentAmount = parseFloat(amountEl.value);

        // Auto-fill amount with remaining fee if there's a half payment, otherwise use monthly fee
        {% if remaining_fee > 0 %}
        const remainingFee = parseFloat("{{ remaining_fee }}");
        if (!amountEl.value || (Number.isFinite(remainingFee) && Number.isFinite(currentAmount) && currentAmount < remainingFee)) {
            amountEl.value = "{{ remaining_fee }}";
        }
        {% else %}
        if (!amountEl.value || (Number.isFinite(fee) && Number.isFinite(currentAmount) && currentAmount < fee)) {
            amountEl.value = "{{ student.monthly_fee }}";
        }
        {% endif %}
    }

    const studentIdInput = document.getElementById('student_id');
    if (studentIdInput) studentIdInput.value = "{{ student.id }}";

    // Auto-fill month and year based on student's last payment
    const monthInput = document.getElementById('month');
    const yearInput = document.getElementById('year');
    const monthDisplay = document.getElementById('month_display');
    const yearDisplay = document.getElementById('year_display');

    if (monthInput && yearInput) {
        monthInput.value = "{{ next_month }}";
        yearInput.value = "{{ next_year }}";

        // Set display values with readable month name
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'];
        if (monthDisplay && yearDisplay) {
            const monthIndex = parseInt("{{ next_month }}") - 1;
            if (monthIndex >= 0 && monthIndex < 12) {
                monthDisplay.value = monthNames[monthIndex];
            }
            yearDisplay.value = "{{ next_year }}";
        }
    }

    // Show remaining fee message if applicable
    {% if remaining_fee > 0 %}
    if (amountEl) {
        const remainingFeeMsg = document.createElement('div');
        remainingFeeMsg.style.cssText = 'color: #f59e0b; font-size: 0.85rem; margin-top: 0.5rem; font-weight: 500;';
        remainingFeeMsg.textContent = 'Remaining fee for this month: Rs.{{ remaining_fee }}';

        // Remove any existing message
        const existingMsg = amountEl.parentNode.querySelector('.remaining-fee-msg');
        if (existingMsg) {
            existingMsg.remove();
        }

        remainingFeeMsg.className = 'remaining-fee-msg';
        amountEl.parentNode.appendChild(remainingFeeMsg);
    }
    {% endif %}
</script>

{% else %}
<!-- No matching student -->
<script>
    // Clear fields if no student found? Or just do nothing?
    // Maybe clear the ID to prevent submission with wrong student
    const sId = document.getElementById('student_id');
    if (sId) sId.value = '';
</script>
{% endif %}